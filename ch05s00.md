# 第五章 - 流复制和逻辑复制

通过上一章的学习，我们已经对PostgreSQL数据库的备份和恢复，以及WAL的基本作用有了一个整体的了解。WAL记录除了可以用在本地数据库的恢复以外，也可以通过网络传输到远端，恢复远端的数据库。这就诞生了数据库的远程复制技术。远程复制技术是实现数据库高可用性的主要技术手段，也是企业迫切需要的核心功能。从实质上来说，远程复制和本地恢复并无本质的区别，其核心都是使用WAL来恢复数据库，无非一个是本地手动执行，一个是把WAL记录通过网络传输到远端，自动执行罢了。下图就是远程复制技术的总体概念：

![](d0053.svg)

远程复制技术分为物理复制和逻辑复制两种类型。简单来说，物理复制就是本地恢复的远端版本，也是把WAL记录回放的方式恢复远端的数据库。逻辑复制是把WAL记录进行解码，变成了SQL语句，在远端执行。逻辑复制带来了更多的灵活性。各大主流数据库都有自己的复制技术，Oracle数据库有Data Guard物理复制和GoldenGate逻辑复制解决方案。微软的SQL Server有Always On的解决方案。作为号称最先进的开源数据库的PostgreSQL当然也有自己的物理流复制和逻辑复制技术，这些就是本章的核心内容。

## 流复制

PostgreSQL流复制的体系架构可以用下图来表示：

![](d0052.svg)

在上图中，左边的大矩形框表示主库，右边的大矩形框表示备库。主库的用户发起的修改数据的事务(INSERT/DELETE/UPDATE)，相关的WAL记录会被写入到WAL文件中。这个大家已经非常熟悉了。在主库上有一个walsender的后端进程，会不断地读取WAL文件中的记录，通过TCP连接，传输给远端备库机器上的walreceiver进程。walreceiver进程收到来自主库的WAL记录后，会写入本地的WAL文件中。备库机器上还有一个startup进程，不断读取WAL文件中的WAL记录，把它们不断更新到数据文件上。


### 快速搭建流复制

我们先通过一个实验，快速搭建PostgreSQL的物理复制环境，给读者一个感性的认识。我们的实验环境分为两台计算机，一台计算机作为主库，IP地址是192.168.137.151，其上已经运行了PostgreSQL 15.2的数据库。另外一台计算机作为备库，它的IP地址是192.168.137.152，上面只安装好了15.2的软件，并没有数据库在运行。


下面是实验的具体内容：

第一步：在主库机器上创建一个用户
```
```

第二步：在备库机器上执行pg_basebackup创建一个备份
```
```

第三步：修改备库参数，启动备库
```
```

第四步：验证物理复制环境搭建是否成功
```
```

### 备库的启动及与主库的通讯过程


作为数据库的管理人员，掌握数据库的备份和各种条件下的恢复技能，是第一要务。

![](d0049.svg)


### 流复制的监控

作为数据库的管理人员，掌握数据库的备份和各种条件下的恢复技能，是第一要务。

![](d0051.svg)


