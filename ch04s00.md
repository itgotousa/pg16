# 第三章 - 理解提前写日志 - WAL

WAL是LWrite Ahead Log的简称，中文可以翻译成“提前写日志”，是PostgreSQL数据库的核心概念之一。它也是Oracle/SQL Server/MySQL等传统数据库的核心概念。在Oracle中WAL被叫做Redo，SQL Server中WAL被叫做Transaction Log。对于它的深入理解，是我们掌握PostgreSQL数据库备份和恢复，Standby服务器和逻辑复制服务器搭建的重要前提条件。本章的内容就是对WAL相关的知识进行基本性的介绍。

## WAL背后的原理

为了理解WAL，我们先考察一个极其简单的理论模型。请参考下图：

![](d0033.svg)

如上图所示，假设我们有一个数字，它在不停的变化，每次变化以后，就会立刻通知观察者。从上图中可以看到，这个数字最初是6，依次变化为9,17,5,23等等。为了要记录这个数字的变化情况，观察者首先能够想到的方案就是：当接到通知后就去观察这个数字，并且把它记录在笔记上，所以观察者的笔记里面记录的是6,9,17,5等数字，可能还有每次观察的时间点等信息。除了这种自然的记录方案以外，我们还可以有第二种记录方案，就是首先记录一个起始值6，然后只记录一下增量值。譬如当6变成9的时候，我们只记录3，因为6 + 3 = 9嘛。所以一旦有了一个初始值，再加上一个增量，观察者就可以计算得到下一个变化的值。我们称这个初始值为基值，只要一个基值6和连续的增量信息，就是底部的+3, +8, -12, +18等等，我们就可以恢复从基值开始变化的任何一种状态。 在这种方案中，我们还可以观察到另外一个规律：就是要从基值6恢复到第8个数字18，我们需要进行7次加法运算。但是当我们把基值调整为19,也就是第6个数字的时候，只需要两次的加法运算，恢复的速度大大提高了。

很显然，第二种基值加增量的方案在这个极其简单的理论模型中，并没有任何优势。但是我们把注意力放在数据库设计领域的时候，第二种方案就有了很大的优势。为什么呢？目前所有的数据库都是在机械磁盘时代设计出来的。在机械磁盘时代，有一个事实，那就是：对机械磁盘的顺序写的速度要远远大于随机写的速度。加上这个前提，我们再来考察上述的第二种方案。如果记录原始值是随机写的，增量的值是顺序写的，写少数原始值加连续的增量，写入速度明显比只纯写原始值要快得多，那么第二种方案就有了很大的优势。这就是WAL的思想起源。WAL就是图上增量的值，它是连续且顺序写入到磁盘文件上的。为了提高恢复速度，我们把基值从6往前移动到9，这个过程在数据库领域称为检查点(Check Point)。这些都是数据库里面的重要概念。理解了这个简单的模型和思想，我们就可以考察PostgreSQL里面如何实现基值加增量的存储方案，以及WAL和检查点等重要概念的基本含义。


### 什么是LSN?

LSN是PostgreSQL里面极其重要的底层概念，它等同于Oracle数据库中的SCN。理解LSN是理解WAL和检查点的前提。那么什么是LSN呢？LSN是Log Sequence Number的缩写，它是一个64-bit的无符号整数，来表示一个空间(Space)。空间这个概念对于学习过线性代数的读者来说并不陌生，它指的是一个集合。8个字节的LSN可以表示0x0000000000000000到0xFFFFFFFFFFFFFFFF这么多个数字，共计2^64(就是2的64次方)个，它们组成了一个集合，即为WAL空间。虽然这个空间不是无限的，但是也是非常非常非常巨大的空间，我们可以把它看成近乎无限大。现在我们设想有一个共计2^26个字节的长长的数组，其中每一个字节的取值从0到255。从左到右，每一个字节都有一个编号，第一个字节的编号是0,最后一个字节的编号是0xFFFFFFFFFFFFFFFF。每一个字节的编号就是该字节的LSN。它的含义可以用下图来表示：

![](d0014.svg)

如上图所示，假设某一个字节的偏移量是716751593320，就是十六进制的A6E1B95F68。为了方便阅读，我们把这8个字节分成高低各4个字节，中间用/分割，A6E1B95F68可以表示为A6/E1B95F68。这个就是该字节的LSN。

### WAL日志的结构

### WAL文件
如下图所示：

![](d0019.svg)

WAL文件名分为三部分，如下图所示：

![](d0021.svg)

WAL segment file的结构

![](d0025.svg)

如上图所示，每一个WAL segment file也是按照8K划分成多个页。

### 检查点Checkpoint

LSN是offset!

![d0001](https://github.com/itgotousa/pg16/blob/main/d0006.svg)

Full Page Write的介绍

![d0001](https://github.com/itgotousa/pg16/blob/main/d0007.svg)

## pg_waldump工具的使用

https://zhmin.github.io/posts/postgresql-checkpoint/
https://zhmin.github.io/posts/postgresql-wal-format/

