# 第四章 - 理解提前写日志(WAL)

https://zhmin.github.io/posts/postgresql-checkpoint/
https://zhmin.github.io/posts/postgresql-wal-format/


Write Ahead Log，简称WAL，中文可以翻译成“提前写日志”，是PostgreSQL数据库的核心概念之一。它也是Oracle/SQL Server/MySQL等传统数据库的核心概念。在Oracle中WAL被叫做Redo，SQL Server中WAL被叫做Transaction Log。对于它的深入理解，是我们掌握PostgreSQL数据库备份和恢复，Standby服务器和逻辑复制服务器搭建的重要前提条件。本章的内容就是对WAL相关的知识进行基本的介绍。

## WAL日志的结构
![d0001](https://github.com/itgotousa/pg16/blob/main/d0008.svg)

## 什么是LSN?

LSN是PostgreSQL里面极其重要的概念，它等同于Oracle数据库中的SCN。LSN是一个64-bit的无符号整数，来表示一个空间(Space)。空间这个概念对于学习过线性代数的读者来说并不陌生，它指的是一个集合。8个字节的LSN可以表示0x0000000000000000到0xFFFFFFFFFFFFFFFF这么多个数字，它们组成了一个集合，即为WAL空间。LSN表示在WAL空间当中某一个字节的偏移量(offset)，也就是这个字节距离WAL空间的第一个字节的距离。注意，第一个字节的编号或者偏移量是0。
它的含义可以用下图来表示。

![](d0014.svg)

如上图所示，假设某一个字节的偏移量是716751593320，就是十六进制的A6E1B95F68。为了方便阅读，我们把这8个字节分成高低各4个字节，中间用/分割，A6E1B95F68可以表示为A6/E1B95F68。这个就是该字节的LSN。

## 检查点Checkpoint

LSN是offset!

![d0001](https://github.com/itgotousa/pg16/blob/main/d0006.svg)

Full Page Write的介绍

![d0001](https://github.com/itgotousa/pg16/blob/main/d0007.svg)

## pg_waldump工具的使用

