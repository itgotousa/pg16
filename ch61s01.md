
# 了解fork()和mmap()

为了理解PostgreSQL的共享内存结构，就必须要掌握一些基础知识。我们在本节重点介绍fork和mmap()的使用。


```c
      1 #include <stdio.h>
      2 #include <stdlib.h>
      3 #include <unistd.h>
      4
      5 #define MEMORY_SIZE    8192
      6
      7
      8 char* g_ptr = NULL;
      9
     10 int main(int argc, char* argv[])
     11 {
     12 pid_t pid;
     13         printf("Hello, this is the testing for fork!\n");
     14
     15         g_ptr = (char*)malloc(MEMORY_SIZE);
     16
     17         if(NULL == g_ptr) {
     18                 printf("Sorry, I cannot allocate %d bytes, so I have to quit!\n", MEMORY_SIZE);
     19                 exit(1);
     20         }
     21
     22         g_ptr[0] = g_ptr[1] = 'A';
     23         g_ptr[2] = 0x00;
     24
     25         pid = fork();
     26
     27         if(pid < 0) {
     28                 printf("Parent: fork is failed. I have to quit!\n");
     29                 if(NULL != g_ptr) free(g_ptr);
     30                 g_ptr = NULL;
     31                 exit(1);
     32         }
     33         else {
     34                 if(0 == pid) { /* fork succeeded, in child */
     35                         printf("Child: I will sleep for a while :-) \n");
     36                         sleep(10);
     37                         printf("Child: g_ptr is %s\n", g_ptr);
     38                         if(NULL != g_ptr) free(g_ptr);
     39                         g_ptr = NULL;
     40                         exit(0);
     41                 }
     42                 else { /* fork succeeded, in parent */
     43                         g_ptr[0] = g_ptr[1] = 'B';
     44                         g_ptr[2] = 0x00;
     45                         printf("Parent: g_ptr is %s\n", g_ptr);
     46                         sleep(20);
     47                 }
     48         }
     49
     50         if(NULL != g_ptr) free(g_ptr);
     51         g_ptr = NULL;
     52
     53         return 0;
     54 }
     55

```
这个例子的输出：
```
postgres@debianpg:~/code$ gcc -Wall f0.c -o f0
postgres@debianpg:~/code$ ./f0
Hello, this is the testing for fork!
Parent: g_ptr is BB
Child: I will sleep for a while :-)
Child: g_ptr is AA
```
从上面的输出结果来看。



