
# 了解fork()和mmap()

为了理解PostgreSQL的共享内存结构，就必须要掌握一些基础知识。我们在本节重点介绍fork和mmap()的使用。


```c
      1 #include <stdio.h>
      2 #include <stdlib.h>
      3 #include <unistd.h>
      4
      5 #define MEMORY_SIZE    8192
      6
      7 char* g_ptr = NULL;
      8
      9 int main(int argc, char* argv[])
     10 {
     11 pid_t pid;
     12         printf("Hello, this is the testing for fork!\n");
     13
     14         g_ptr = (char*)malloc(MEMORY_SIZE);
     15
     16         if(NULL == g_ptr) {
     17                 printf("Sorry, I cannot allocate %d bytes, so I have to quit!\n", MEMORY_SIZE);
     18                 exit(1);
     19         }
     20
     21         g_ptr[0] = g_ptr[1] = 'A'; g_ptr[2] = 0x00;
     22
     23         pid = fork();   /* <--------- this is the key point!!!!!!! --------------- */
     24
     25         if(pid < 0) {
     26                 printf("Parent: fork is failed. I have to quit!\n");
     27                 if(NULL != g_ptr) free(g_ptr);
     28                 g_ptr = NULL;
     29                 exit(1);
     30         }
     31         else {
     32                 if(0 == pid) { /* fork succeeded, in child */
     33                         printf("Child: I will sleep for a while :-) \n");
     34                         sleep(10);
     35                         printf("Child: g_ptr is %s\n", g_ptr);
     36                         if(NULL != g_ptr) {
     37                                 printf("Child: I will free g_ptr.\n");
     38                                 free(g_ptr);
     39                                 g_ptr = NULL;
     40                         }
     41                         exit(0);
     42                 }
     43                 else { /* fork succeeded, in parent */
     44                         g_ptr[0] = g_ptr[1] = 'B'; g_ptr[2] = 0x00;
     45                         printf("Parent: g_ptr is %s\n", g_ptr);
     46                         sleep(20);
     47                 }
     48         }
     49
     50         if(NULL != g_ptr) {
     51                 printf("Parent: I will free g_ptr.\n");
     52                 free(g_ptr);
     53                 g_ptr = NULL;
     54         }
     55

```
这个例子的输出：
```
postgres@debianpg:~/code$ gcc -Wall f0.c -o f0
postgres@debianpg:~/code$ ./f0
Hello, this is the testing for fork!
Parent: g_ptr is BB
Child: I will sleep for a while :-)
Child: g_ptr is AA
Child: I will free g_ptr.
Parent: I will free g_ptr.

```
从上面的输出结果来看。



