## 检查点CheckPoint

检查点CheckPoint是数据库的重要概念。

![](d0027.svg)

三个重要的检查点相关参数

![](d0032.svg)


三个重要的检查点相关参数
```c
/* in src/backend/postmaster/checkpointer.c *
int			  CheckPointTimeout = 300;
int			  CheckPointWarning = 30;
double		CheckPointCompletionTarget = 0.9;
```
这三个参数的含义如下。
```c
/* in src/backend/postmaster/checkpointer.c */
typedef struct {
	pid_t		 checkpointer_pid;	/* PID (0 if not started) */
	slock_t	 ckpt_lck;		/* 自旋锁，用来保护本结构中所有的ckpt_*成员变量 */

  int			 ckpt_started;	/* advances when checkpoint starts */
	int			 ckpt_done;		/* advances when checkpoint done */
	int			 ckpt_failed;	/* advances when checkpoint fails */

	int			ckpt_flags;		/* checkpoint flags, as defined in xlog.h */

	ConditionVariable start_cv; /* signaled when ckpt_started advances */
	ConditionVariable done_cv;	/* signaled when ckpt_done advances */

	uint32		num_backend_writes; /* counts user backend buffer writes */
	uint32		num_backend_fsync;	/* counts user backend fsync calls */

	int			num_requests;	/* current # of requests */
	int			max_requests;	/* allocated array size */
	CheckpointerRequest requests[FLEXIBLE_ARRAY_MEMBER];
} CheckpointerShmemStruct;
```
定义如下：
```c
/* in src/include/storage/sync.h */
typedef struct FileTag
{
        int16           handler;                /* SyncRequestHandler value, saving space */
        int16           forknum;                /* ForkNumber, saving space */
        RelFileNode     rnode;
        uint32          segno;
} FileTag;

/* in src/backend/postmaster/checkpointer.c */
typedef struct
{
	SyncRequestType type;		/* request type */
	FileTag		ftag;			/* file identifier */
} CheckpointerRequest;

```
定义如下：
```c
/* in src/include/storage/sync.h */
typedef enum SyncRequestType
{
        SYNC_REQUEST,                           /* schedule a call of sync function */
        SYNC_UNLINK_REQUEST,            /* schedule a call of unlink function */
        SYNC_FORGET_REQUEST,            /* forget all calls for a tag */
        SYNC_FILTER_REQUEST                     /* forget all calls satisfying match fn */
} SyncRequestType;

```
定义如下：

![](d0031.svg)

```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
