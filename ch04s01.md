## 检查点CheckPoint

检查点CheckPoint是数据库的重要概念。

![](d0027.svg)

三个重要的检查点相关参数

![](d0032.svg)


三个重要的检查点相关参数

### CheckPoint的执行过程

我们可以使用下图来展示CheckPoint的执行过程。在图中，水平实线表示各种对象，包括Checkpointer进程，Shared Buffer池，WAL Buffer，各种磁盘文件等等，其含义在左边对应列出。水平虚线分割上下两部分，上部分表示内存，下部分表示磁盘。

![](d0031.svg)

步骤(1)是CheckPoint发生的开始，此时Checkpointer进程会首先记录当前的WAL指针的位置，称为REDO point。紧接着步骤(2)开始在shared buffer池中寻找脏页，依次把这些脏页写入到磁盘的数据文件中。步骤(3)表示把脏页刷新到数据文件的过程。这个过程可能很长，持续几十分钟都不罕见。当所有的脏页被写入到数据文件以后，进入到了步骤(4)，它的动作是往WAL文件中插入一个CheckPoint的WAL记录。步骤(5)是把步骤(4)中的CheckPoint信息写入到控制文件.

我们可以参考下面的关键源代码

```c
/* in src/backend/access/transam/xlog.c:CreateCheckPoint() */

void CreateCheckPoint(int flags)
{
    ...
    curInsert = XLogBytePosToRecPtr(Insert->CurrBytePos);
    ...
    checkPoint.redo = curInsert;   /* 把当前WAL的位置记录在redo中 */
    ...
    CheckPointGuts(checkPoint.redo, flags);
    ...
    XLogBeginInsert(); /* 这部分代码是执行步骤(4)，把CheckPoint WAL记录写入WAL文件中 */
    XLogRegisterData((char *) (&checkPoint), sizeof(checkPoint));
    recptr = XLogInsert(RM_XLOG_ID, shutdown ? XLOG_CHECKPOINT_SHUTDOWN : XLOG_CHECKPOINT_ONLINE);

    XLogFlush(recptr);
    ...
    UpdateControlFile();  /* 步骤(5)更新控制文件 */
    ...
}

```
定义如下：

![](d0034.svg)

```c
```
定义如下：

![](d0037.svg)

```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
定义如下：
```c
```
