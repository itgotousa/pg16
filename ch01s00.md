# 第一章 - 搭建实验环境和体系结构概述

PostgreSQL，简称PG，是著名的开源数据库软件，具有非常良好的设计和高质量的代码。很多公司都以PostgreSQL为内核，开发出各种有自己特色的数据库产品。很多高校的计算机相关专业也以PostgreSQL为技术原型，研究和传授数据库相关的理论和具体实现。

本章是第一章，自然要介绍如何搭建自己的PostgreSQL的学习实验环境。学习PostgreSQL，如果不去阅读源码，理解其背后的技术秘密，就是辜负了“开源”两个字。故本章只给大家讲解如何从源码开始安装PostgreSQL，既学习PostgreSQL的外在软件功能，又探究其背后的源码实现和技术秘密。努力做到“知其然且知其所以然”是本书最大的特色之一。

本书要求读者具备一定的Linux使用经验和初步的C语言编程的能力，能够看懂基本的C语言源代码。本书的全部实验都是在Linux环境下进行的，不讨论Windows环境。如果读者不具备Linux基本操作和C语言编程的能力，也不要担心，可以快速地在互联网上寻找相关资料进行快速学习。这方面的文档和视频等学习资料在互联网上非常丰富。读者无需花费太多时间学习Linux和C的知识，只需恶补一个星期左右的学习时间，所掌握的Linux和C编程的能力就足够学习本书的内容了。

如何安装Linux环境，我就不重复介绍了，互联网上这方面的资料也非常多。我建议读者使用VMWare/Virtual Box/Docker等虚拟机软件来运行Linux。本书所有的实验是在Debian Linux 11上完成的，所使用的用户统一为postgres。但是本书和Debian几乎没有关系，所以读者可以选择任何自己喜欢的Linux发行版本，也可以顺利地把本书的各种实验完成。

在本书开始写作的时候，PostgreSQL最新的版本是15.2。可能读者在阅读本书的时候，PostgreSQL已经发布了更高的版本。但是本书绝大部分的内容是通用的，适用几乎PostgreSQL 10以后的所有版本。

## 搭建实验环境

### 下载源码包
我们访问PostgreSQL的官方网站(www.postgresql.org)，  很容易找到Download的入口，选择下载源码包到本地。例如我下载了postgresql-15.2.tar.gz或者postgresql-15.2.tar.bz2两个文件。它们都是PostgreSQL 15.2的源码包，只不过是压缩的格式不同，一个是gzip格式，一个是bz2格式。紧接着我们需要把源码包文件上传到Linux实验服务器上，然后在postgres用户拥有写权限的某一个目录下，例如/home/postgres/lab，把源码包解开，如下所示：
```
$ id        /* <-- 任何用户都可以。我推荐使用postgres用户，它所在的组也是postgres */
uid=1000(postgres) gid=1000(postgres) groups=1000(postgres)......
postgres
$ pwd
/home/postgres/lab
$ ls -l
total 29116
-rw-r--r-- 1 postgres postgres 29811750 Feb 27 17:26 postgresql-15.2.tar.gz
$ tar zxvf postgresql-15.2.tar.gz  /* 解压缩源码包。如果是*.tar.bz2格式，就使用tar jxvf的选项 */
$ ls -l
total 29120
drwxr-xr-x 6 postgres postgres     4096 Feb  6 14:51 postgresql-15.2   /* 这个是解压缩后产生的目录 */
-rw-r--r-- 1 postgres postgres 29811750 Feb 27 17:26 postgresql-15.2.tar.gz
```
注意，本书使用C语言风格的多行注释/* xxxxxx */来解释实验中每一步命令的含义和要点。这些注释仅仅是为了方便读者理解实验过程或者源代码的含义，并不是输入的命令或者输出结果的一部分。

因为我们要对源码进行编译，所以常用的开发工具gcc和调试工具gdb是必不可少的。你必须确保gcc和gdb在你的Linux实验服务器上已经安装好了。检测的方法是执行下面的命令：
```
$ gcc --version
gcc (Debian 10.2.1-6) 10.2.1 20210110
Copyright (C) 2020 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

$ gdb --version
GNU gdb (Debian 10.1-1.7) 10.1.90.20210103-git
Copyright (C) 2021 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
```
如果出现类似“command not found”的错误，就说明gcc或者gdb没有安装好。你需要先解决这个问题，再进行下面的安装步骤。

### 编译源码和安装PG软件
我们进入到postgre源码目录，运行ls -l命令，会看到里面有很多文件和目录。其中两个目录需要我们注意。一个是src目录，这里面包含了PostgreSQL的所有核心源码。另外一个是contrib目录，它里面包含了一些外围的工具包的源代码。假设我们准备把PostgreSQL安装到/opt/software目录下。PostgreSQL数据库的数据目录在/opt/data下。你需要以root用户，使用类似chown -R postgres:postgres /opt/software的命令设置让postgres用户拥有这个目录，从而有读写写权限。
```
$ ls -l /opt  /* 注意你需要让postgres用户对下面两个目录有读写权限 */
total 8   
drwxr-xr-x 3 postgres postgres 4096 Feb 23 14:27 data      
drwxr-xr-x 3 postgres postgres 4096 Feb 23 14:23 software  
```
然后在/home/postgres/lab/postgresql-15.2目录下运行如下三条命令就可以进行源码编译和安装了。
```
./configure --prefix=/opt/software/pg152 --enable-depend --enable-debug --enable-cassert CFLAGS="-O0"
make world
make install-world
```
在上面的三条命令中，configure命令是根据你的Linux环境产生一系列的补充文件如pg_config.h等，最终产生Makefile，供下一步的make命令进行编译。我使用了--enable-depend --enable-debug --enable-cassert这三个选项是为了后面使用gdb进行调试分析源码使用的。CFLAGS="-O0"表示禁止编译过程中进行优化，进一步提高了我们在gdb调试过程中源代码的可读性。注意，这三个选项不能用于编译部署在生产环境中的PostgreSQL。
make world表示把contrib目录里面的工具包也一并编译。这些工具包对我们的后续分析工作非常有帮助。make install-world是把编译好的软件拷贝到我们执行的目录/opt/software/pg152下面。

注意：这里面一个常见的问题是configure命令运行之后，抱怨readline和zlib的开发包找不到。readline是PostgreSQL的客户端psql使用的，它可以方便我们用上下箭头把以前输入的命令重新调出来使用，提高了效率。zlib是Postgres在内部压缩的时候使用的库。你执行完configure命令后，仔细阅读输出的最后部分。如果发现了缺乏readline和zlib的信息，请在互联网上搜索如何在你的Linux环境中安装readline和zlib开发包的解决方案。如果你实在解决不了这些问题，configure也提供了几个--without的选项跳过这些开发包。

等第三部make install-word结束后，你可以执行如下命令，检查一下软件是否安装好了：
```
$ ls -l /opt/software/
total 4
drwxr-xr-x 6 postgres postgres 4096 Feb 23 14:23 pg152

$ ls -l /opt/software/pg152
total 16
drwxr-xr-x 2 postgres postgres 4096 Feb 23 14:23 bin
drwxr-xr-x 4 postgres postgres 4096 Feb 23 14:23 include
drwxr-xr-x 4 postgres postgres 4096 Feb 23 14:23 lib
drwxr-xr-x 5 postgres postgres 4096 Feb 23 14:23 share

$ ls -l /opt/software/pg152/bin/postgres
-rwxr-xr-x 1 postgres postgres 29703048 Feb 23 14:23 /opt/software/pg152/bin/postgres
```
如果出现类似上面的目录，则恭喜你，你已经成功地把PostgreSQL顺利地安装到了你的实验环境中了。下面我们就可以进行一次猪八戒吃人参果式的快速体验了，了解一下传说中的PostgreSQL到底是一个什么东东。

### PostgreSQL的初次体验

#### 常用环境变量的设置

我们知道，在Linux环境下的软件，往往需要设置一些环境变量来配合软件的运行，如Oracle软件需要设置著名的ORACLE_HOME和ORACLE_SID等环境变量。PostgreSQL常用的环境变量有两个：PGHOME和PGDATA。它们的含义如下：
- PGHOME指向PostgreSQL的软件安装目录，在我们这里是/opt/software/pg152。然后你把$PGHOME/bin加入到PATH环境变量当中以后，就可以在任何地方使用PostgreSQL的各种命令了，无须每次运行的时候都要指定该命令程序所在的目录，避免了繁琐。
- PGDATA指向了PostgreSQL的数据库目录。在PostgreSQL的很多工具中都存在一个基本的逻辑：如果命令行中输入了 -D（注意是大D，不是小d）的选项，则使用-D后面的路径作为数据库的目录。如果没有-D选项，则读取PGDATA里面的路径信息作为数据库的目录。因为一旦设置了PGDATA，就无需使用-D指定数据库目录了，所以强烈建议大家设置该目录。本书实验环境中，PGDATA指向了/opt/data/pgdata1，这个目录可以不需要存在，我们在下面会使用initdb命令创建它。

为了方便后续的使用，建议大家参考下面的例子设置这两个环境变量：
```
$ cat set.env   /* 准备一个set.env的文本文件 */
PGHOME=/opt/software/pg152
PGDATA=/opt/data/pgdata1
PATH=$PGHOME/bin:$PATH
LD_LIBRARY_PATH=$PGHOME/lib:$LD_LIBRARY_PATH
export PGHOME PGDATA PATH LD_LIBRARY_PATH

$ chmod +x set.env  /* 给这个文件赋予可以执行的权限 */

$ . ./set.env       /* 这个命令就是设置环境变量。注意是两个点，中间有一个空格 */

$ env | grep PG   /* 检查一下环境变量是否生效了 */
PGHOME=/opt/software/pg152
PGDATA=/opt/data/pgdata1
```
当然你也可以把set.env里面的内容放在postgres用户的.bash_profile或者.profile中。这样你每次登录linux服务器，这些设置会自动生效，更加方便。

#### 创建数据库
很显然下面我们要创建我们第一个PostgreSQL的数据库了。创建数据库的命令是pg_ctl或者initdb。pg_ctl是一个wrapper工具，通过它，我们可以完成启动和关闭数据库等各种操作。initdb是一个专门创建数据库的小工具。PostgreSQL中各种软件都会带一个--help的选项（注意是两个连起来的减号），来显示本软件的功能，用法和各种输入参数的含义。例如：pg_ctl --help或者initdb --help等等。

下面我们使用initdb来创建数据库：
```
$ env | grep PG
PGHOME=/opt/software/pg152
PGDATA=/opt/data/pgdata1  /* 我们已经设置了PGDATA环境变量 */
$ ls -l /opt/data  /* /opt/data/pgdata1目录不存在 */
total 0
/* 因为PGDATA已经设置好了，所以下面的-D选项是多余的，你可以简单输入initdb */
$ initdb -D /opt/data/pgdata1 
...   /* 在这里我们省略了大量的输出 */

$ ls -l /opt/data  /* 发现pgdata1目录已经被创建了 */
total 4
drwx------ 19 postgres postgres 4096 Mar  1 22:32 pgdata1
$ ls -l /opt/data/pgdata1     /* 这是一个数据库的基本目录布局 */
total 128
drwx------ 6 postgres postgres  4096 Feb 24 14:38 base
drwx------ 2 postgres postgres  4096 Mar  1 23:06 global
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_commit_ts
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_dynshmem
-rw------- 1 postgres postgres  4789 Feb 23 14:27 pg_hba.conf
-rw------- 1 postgres postgres  1636 Feb 23 14:27 pg_ident.conf
drwx------ 4 postgres postgres  4096 Mar  2 03:17 pg_logical
drwx------ 4 postgres postgres  4096 Feb 23 14:27 pg_multixact
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_notify
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_replslot
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_serial
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_snapshots
drwx------ 2 postgres postgres  4096 Feb 27 11:34 pg_stat
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_stat_tmp
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_subtrans
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_tblspc
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_twophase
-rw------- 1 postgres postgres     3 Feb 23 14:27 PG_VERSION
drwx------ 3 postgres postgres  4096 Feb 27 11:41 pg_wal
drwx------ 2 postgres postgres  4096 Feb 23 14:27 pg_xact
-rw------- 1 postgres postgres    88 Feb 23 14:27 postgresql.auto.conf
-rw------- 1 postgres postgres 29484 Feb 24 20:53 postgresql.conf
-rw------- 1 postgres postgres    33 Mar  1 22:32 postmaster.opts
-rw------- 1 postgres postgres    82 Mar  1 22:32 postmaster.pid
```
在上面的实验中，因为环境变量PGDATA已经被设置好了，所以initdb命令后面无需指定任何参数，就可以创建数据库了。当然initdb有很多选项，我们用到的时候再介绍。

#### 启停数据库和基本使用
当数据库创建完毕后

使用psql登录数据库
```
postgres@debianpg:/opt/data$ psql
psql (15.2)
Type "help" for help.

postgres=# \l
                                                 List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges
-----------+----------+----------+-------------+-------------+------------+-----------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres
(3 rows)

postgres=# \q

```
至此，我们已经完成了PostgreSQL的学习实验环境的搭建工作，也初步体验了一下PostgreSQL的基本使用。在下一节，我们会学习PostgreSQL的体系结构的知识。

