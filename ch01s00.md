# 第一章 - 安装和体系结构概述

PostgreSQL，简称PG，是著名的开源数据库软件，具有非常良好的设计和高质量的代码。很多公司都以PostgreSQL为内核，开发出各种有自己特色的数据库产品。很多高校的计算机专业也以PostgreSQL为技术原型，研究和传授数据库相关的理论和具体实现。

本章是第一章，自然要介绍如何搭建自己的PostgreSQL的学习实验环境。学习PostgreSQL，如果不去阅读源码，理解其背后的技术秘密，就是辜负了“开源”两个字，故本章只给大家介绍如何从源码开始安装PostgreSQL。既学习PostgreSQL的软件功能，又学习背后的源码实现，努力做到“知其然且知其所以然”是本书最大的特色之一。

本书要求读者具备一定的Linux使用经验和初步C语言的编程能力，能够看懂基本的C语言源代码。本书的全部实验都是在Linux环境下进行的，不讨论Windows环境。如果你不具备Linux基本操作和C编程的能力，可以快速地在互联网上寻找相关资料进行快速学习。这方面的文档和视频等学习资料在互联网上非常丰富。你无需花费太多时间学习Linux和C的知识。恶补一个星期的时间，所掌握的Linux和C编程的能力就足够学习本书的内容了。

如何安装Linux环境，我就不重复介绍了，互联网上这方面的资料也非常多。我建议你使用VMWare/Virtual Box/Docker等虚拟机软件来运行你的Linux。本书所有的实验是在Debian Linux 11上完成的，所使用的用户统一为postgres。但是本书和Debian几乎没有关系，所以你选择任何你喜欢的Linux发行版本，也可以顺利地把本书的各种实验完成。

在本书开始写作的时候，PostgreSQL最新的版本是15.2。可能你在阅读本书的时候，PostgreSQL已经发布了更高的版本。但是本书绝大部分的内容是通用的，适用几乎PostgreSQL 9以后的所有版本。

## PostgreSQL的安装过程

### 下载源码包
你访问PostgreSQL的官方网站(www.postgresql.org)，  很容易找到Download的入口，选择下载源码包到本地。例如我下载了postgresql-15.2.tar.gz或者postgresql-15.2.tar.bz2两个文件。它们都是PostgreSQL 15.2的源码包，只不过是压缩的格式不同，一个是gzip格式，一个是bz2格式。你把源码包文件上传到你的Linux实验服务器上，在postgres用户可以写的某一个目录下，例如/home/postgres/lab，就可以把源码包解开，如下所示：
```
$ id        /* <----- 任何用户都可以。我推荐使用postgres用户，它所在的组也是postgres */
uid=1000(postgres) gid=1000(postgres) groups=1000(postgres)......
postgres
$ pwd
/home/postgres/lab
$ ls -l
total 29116
-rw-r--r-- 1 postgres postgres 29811750 Feb 27 17:26 postgresql-15.2.tar.gz
$ tar zxvf postgresql-15.2.tar.gz  /* <--- 解压缩源码包。如果是*.tar.bz2格式，就使用tar jxvf的选项 */
$ ls -l
total 29120
drwxr-xr-x 6 postgres postgres     4096 Feb  6 14:51 postgresql-15.2   /* <-- 这个是解压缩后产生的目录 */
-rw-r--r-- 1 postgres postgres 29811750 Feb 27 17:26 postgresql-15.2.tar.gz
```
注意，本书使用C语言风格的注释/* xxxxxx */来解释实验中每一步命令的含义和要点。

### 编译源码和安装PG软件
我们进入到postgre源码目录，运行ls -l命令，会看到里面有很多文件和目录。其中两个目录需要我们注意。一个是src目录，这里面包含了PostgreSQL的所有核心源码。另外一个是contrib目录，它里面包含了一些外围的工具包的源代码。假设我们准备把PostgreSQL安装到/opt/software目录下。PostgreSQL数据库的数据目录在/opt/data下。你需要以root用户，使用类似chown -R postgres:postgres /opt/software的命令设置让postgres用户拥有这个目录，从而有读写写权限。
```
$ ls -l /opt  /* 注意你需要让postgres用户对下面两个目录有读写权限 */
total 8   
drwxr-xr-x 3 postgres postgres 4096 Feb 23 14:27 data      
drwxr-xr-x 3 postgres postgres 4096 Feb 23 14:23 software  
```
然后在/home/postgres/lab/postgresql-15.2目录下运行如下三条命令就可以进行源码编译和安装了。
```
./configure --prefix=/opt/software/pg152 --enable-depend --enable-debug --enable-cassert CFLAGS="-O0"
make world
make install-world
```
在上面的三条命令中，configure命令是根据你的Linux环境产生一系列的补充文件如pg_config.h等，最终产生Makefile，供下一步的make命令进行编译。我使用了--enable-debug --enable-cassert选项是为了后面使用gdb进行调试分析源码使用的。CFLAGS="-O0"表示禁止编译过程中进行优化，进一步提高了我们在gdb调试过程中源代码的可读性。这三个选项不能用于编译部署在生产环境中的PostgreSQL。
make world表示把contrib目录里面的工具包也一并编译。这些工具包对我们的后续分析工作非常有帮助。

### 创建PostgreSQL数据库和基本使用
设置环境变量
```
postgres@debianpg:~$ pwd
/home/postgres
postgres@debianpg:~$ cat .profile
......
export PGHOME=/opt/software/pg152
export PGDATA=/opt/data/pgdata1

export PATH=$PGHOME/bin:$PATH
export LD_LIBRARY_PATH=$PGHOME/lib:$LD_LIBRARY_PATH

```
使环境变量生效。

```
postgres@debianpg:~$ initdb -k -D /opt/data/pgdata1
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are enabled.    <-- 注意这里，initdb命令中的-k选项打开的数据页cheksum保护机制

creating directory /opt/data/pgdata1 ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... US/Mountain
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

initdb: warning: enabling "trust" authentication for local connections
initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    pg_ctl -D /opt/data/pgdata1 -l logfile start

postgres@debianpg:~$ cd /opt/software/
```
使用psql登录数据库
```
postgres@debianpg:/opt/data$ psql
psql (15.2)
Type "help" for help.

postgres=# \l
                                                 List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges
-----------+----------+----------+-------------+-------------+------------+-----------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres
(3 rows)

postgres=# \q

```


