
## Buffer Manager的结构分析

当一个进程访问

下面是BufferTag的定义：

```c
typedef unsigned int Oid;
typedef uint32 BlockNumber;

typedef enum ForkNumber
{
        InvalidForkNumber = -1,
        MAIN_FORKNUM = 0,
        FSM_FORKNUM,
        VISIBILITYMAP_FORKNUM,
        INIT_FORKNUM
} ForkNumber;

typedef struct RelFileNode
{
        Oid                     spcNode;                /* tablespace */
        Oid                     dbNode;                 /* database */
        Oid                     relNode;                /* relation */
} RelFileNode;

typedef struct buftag
{
        RelFileNode rnode;                      /* physical relation identifier */
        ForkNumber      forkNum;
        BlockNumber blockNum;           /* blknum relative to begin of reln */
} BufferTag;

```
我们可以看到，BufferTag是一个五元组，里面包含五个整数，形式是((a,b,c),x,y)。(a,b,c)是一个三元组，表示rnode，就是一个

```
typedef struct BufferDesc
{
        BufferTag       tag;                    /* ID of page contained in buffer */
        int                     buf_id;                 /* buffer's index number (from 0) */

        /* state of the tag, containing flags, refcount and usagecount */
        pg_atomic_uint32 state;

        int                     wait_backend_pgprocno;  /* backend of pin-count waiter */
        int                     freeNext;               /* link in freelist chain */
        LWLock          content_lock;   /* to lock access to buffer contents */
} BufferDesc;

#define BUFFERDESC_PAD_TO_SIZE  (SIZEOF_VOID_P == 8 ? 64 : 1)

typedef union BufferDescPadded
{
        BufferDesc      bufferdesc;
        char            pad[BUFFERDESC_PAD_TO_SIZE];
} BufferDescPadded;


```
