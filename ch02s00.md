# 第二章 - PostgreSQL体系架构介绍

在第一章中我们已经学会了如何在Linux环境下采用编译源码的方式来搭建我们的PostgreSQL学习实验环境。在本章中，我们介绍PostgreSQL的体系架构。

由于读者已经具备了Linux基本操作和C语言基本编程的能力，我假定读者已经对“进程”(process)和“内存”(memory)等基本概念有了初步理解。如果你对这些重要概念还一头雾水，建议你先自行搜索学习这些重要的概念。

## PostgreSQL的后台进程

什么是进程？进程就是一个正在运行中的程序。我们可以通过Linux的ps命令来查看当前操作系统中所有运行的进程。譬如下面的例子：
```
postgres@debianpg:~/code$ ps -ef | grep postgres
postgres   20228   20227  0 14:27 pts/0    00:00:00 -bash
postgres   20254       1  0 14:27 ?        00:00:00 /opt/software/pg152/bin/postgres
postgres   20255   20254  0 14:27 ?        00:00:00 postgres: checkpointer
postgres   20256   20254  0 14:27 ?        00:00:00 postgres: background writer
postgres   20258   20254  0 14:27 ?        00:00:00 postgres: walwriter
postgres   20259   20254  0 14:27 ?        00:00:00 postgres: autovacuum launcher
postgres   20260   20254  0 14:27 ?        00:00:00 postgres: logical replication launcher
postgres   21790   21693  0 22:26 pts/2    00:00:00 grep postgres
```
上图展示了一个PostgreSQL实例(Instance)的常见的后台进程。进程可以通过fork()之类的系统调用来产生出新进程，这个新进程和老进程之间形成父子关系：老进程为父进程，新进程为子子进程。当然，我们把这种关系称为母子关系应该是更恰当的，毕竟是母亲生出儿子，父亲只是做配合工作。但是约定俗成，在计算机领域依然称为父进程和子进程。由此类推，可以形成曾祖，祖父，父亲，儿子，孙子等进程之间的关系。

## PostgreSQL的内存结构

任何程序都不可避免地要使用内存。内存有两种类型，私有内存和共享内存。
- 私有内存是一个进程通过malloc等系统调用从操作系统申请过来只供自己使用的内存。别的进程是没有办法访问这块内存的。我们把这样的内存称为私有内存，也可以叫做本地内存。
- 共享内存，关键点在共享二字。顾名思义，就是一个进程申请的内存可以被其它进程所访问。这块内存是两个或者多个进程都可以访问(或读或写）的，是共享的。



## 数据库集群(Database Cluster)的概念

在PostgreSQL的世界里面有一个重要的概念，叫做Database Cluster，中文翻译是“数据库集群”。它简称为Cluster，中文翻译是“集群”。这个概念很容易让初学者迷惑。在大部分人头脑里面，Cluster/集群的概念指的是协同工作的多台计算机的集合，可以被视为一个整体。例如Oracle数据库中的RAC，SQL Server中的Windows Cluster。但是在PG里面，Database Cluster是指一台机器上的一个目录。在这个目录中包含了多个子目录，每一个子目录是一个数据库，多个数据库在一起，叫做Database Cluster。但是实际上PG Database Cluster是运行在一台机器上的。这一点会让初学者有点失望。多台机器组成的“真正”的PG数据库机器的集群，不是本书所讨论的内容。

简而言之，Cluster就是一个目录加一个TCP侦听端口号。为了在一台机器上同时运行多个Cluster，我们必须要保证每一个Cluster拥有不同的目录，而且它的TCP侦听端口号没有被别的进程占用。举例来说，Cluster1的目录是/opt/data/pgdata1，它的port是5432。Cluster2的目录是/opt/data/pgdata2，它的port是5433，则我们可以同时运行这两个cluster。
